# 训练脚本错误问题分析

## 错误信息
```
FileNotFoundError: Failed to load weights from ./pretrained_weights/dinov2_vitb14_pretrain.pth: 
[Errno 2] No such file or directory: './pretrained_weights/dinov2_vitb14_pretrain.pth'
```

## 问题根本原因

### 1. 文件存在情况
- ✅ `pretrained_weights/DINO_QDFL_U1652.pth` **存在** (435MB)
- ❌ `checkpoint/DINO_QDFL_U1652.pth` **不存在** (checkpoint目录为空)
- ❌ `pretrained_weights/dinov2_vitb14_pretrain.pth` **不存在** (官方DINOv2权重未下载)

### 2. 脚本逻辑缺陷（修复前）

**原始脚本的问题流程：**

```bash
# 第34行：设置了checkpoint路径
DINOV2_CHECKPOINT="checkpoint/DINO_QDFL_U1652.pth"

# 第75-79行：只检查checkpoint文件
if [ -n "$DINOV2_CHECKPOINT" ] && [ -f "$DINOV2_CHECKPOINT" ]; then
    export DINOV2_VITB14_WEIGHT="$DINOV2_CHECKPOINT"
    echo "使用 checkpoint 中的 backbone 权重: $DINOV2_CHECKPOINT"
fi
# ⚠️ 问题：如果checkpoint不存在，脚本不会设置 DINOV2_VITB14_WEIGHT 环境变量
```

**Python代码的回退机制：**

```python
# dinov2.py 第22行
'dinov2_vitb14': os.environ.get(
    'DINOV2_VITB14_WEIGHT',  # 环境变量不存在时
    os.path.join(DINOV2_WEIGHTS_BASE, 'dinov2_vitb14_pretrain.pth')  # 使用默认路径
)
```

### 3. 问题链条

```
1. 脚本检查 checkpoint/DINO_QDFL_U1652.pth → ❌ 不存在
2. 脚本没有设置 DINOV2_VITB14_WEIGHT 环境变量
3. Python代码尝试从环境变量获取 → 环境变量为空
4. Python代码使用默认路径 → ./pretrained_weights/dinov2_vitb14_pretrain.pth
5. 尝试加载文件 → ❌ 文件不存在 → 抛出 FileNotFoundError
```

### 4. 为什么没有使用 DINO_QDFL_U1652.pth？

**原因：** 原始脚本的逻辑不完整，只检查了checkpoint目录，没有检查pretrained_weights目录下的其他文件。

虽然 `pretrained_weights/DINO_QDFL_U1652.pth` 存在，但脚本没有尝试使用它。

## 解决方案

### 已实施的修复

修改了 `scripts/train.sh`，添加了完整的回退机制：

```bash
# 修复后的逻辑（按优先级顺序检查）：
1. 检查 checkpoint/DINO_QDFL_U1652.pth → 如果存在，使用它
2. 检查 pretrained_weights/DINO_QDFL_U1652.pth → 如果存在，使用它 ✅
3. 检查 pretrained_weights/dinov2_vitb14_pretrain.pth → 如果存在，使用它
4. 如果都不存在 → 显示错误信息和下载提示
```

### 代码兼容性

`dinov2.py` 的 `load_dino()` 方法已经支持从checkpoint文件中提取backbone权重：

- 支持包含 `backbone.model.` 前缀的checkpoint
- 支持 PyTorch Lightning 格式的checkpoint（包含 `state_dict`）
- 支持直接的state_dict格式

因此，`DINO_QDFL_U1652.pth` 无论是哪种格式，都能被正确加载。

## 验证修复

运行修复后的脚本应该能够：
1. 检测到 `pretrained_weights/DINO_QDFL_U1652.pth` 存在
2. 设置 `DINOV2_VITB14_WEIGHT` 环境变量指向该文件
3. Python代码成功加载权重文件
4. 训练正常开始
